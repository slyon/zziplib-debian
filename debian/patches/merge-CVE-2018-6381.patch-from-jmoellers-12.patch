From: Guido Draheim <guidod@gmx.de>
Date: Thu, 1 Feb 2018 12:27:49 +0100
Subject: merge CVE-2018-6381.patch from @jmoellers #12
Origin: https://github.com/gdraheim/zziplib/commit/a803559fa9194be895422ba3684cf6309b6bb598
Bug-Debian-Security: https://security-tracker.debian.org/tracker/CVE-2018-6381
Bug-Debian: https://bugs.debian.org/889096
Bug: https://github.com/gdraheim/zziplib/issues/12

---
 zzip/memdisk.c | 8 ++++++++
 1 file changed, 8 insertions(+)

--- a/zzip/memdisk.c
+++ b/zzip/memdisk.c
@@ -191,6 +191,14 @@ zzip_mem_entry_new(ZZIP_DISK * disk, ZZI
     item->zz_diskstart = zzip_disk_entry_get_diskstart(entry);
     item->zz_filetype = zzip_disk_entry_get_filetype(entry);
 
+    /*
+     * If the file is uncompressed, zz_csize and zz_usize should be the same
+     * If they are not, we cannot guarantee that either is correct, so ...
+     */
+    if (item->zz_compr == ZZIP_IS_STORED && item->zz_csize != item->zz_usize)
+    {
+        goto error;
+    }
     {                           /* copy the extra blocks to memory as well */
         int /*            */ ext1 = zzip_disk_entry_get_extras(entry);
         char *_zzip_restrict ptr1 = zzip_disk_entry_to_extras(entry);
@@ -234,6 +242,9 @@ zzip_mem_entry_new(ZZIP_DISK * disk, ZZI
      */
     return item;
     ____;
+error:
+    zzip_mem_entry_free(item);
+    return 0;
     ____;
 }
 
